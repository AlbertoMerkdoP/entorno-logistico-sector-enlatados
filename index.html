<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logística del Atún | Informe Técnico</title>
    
    <!-- Fuentes Premium -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        'brand-blue': '#2997ff',
                        'brand-red': '#ff453a',
                        'brand-gold': '#ffd700',
                        'glass-bg': 'rgba(20, 20, 22, 0.85)',
                        'glass-border': 'rgba(255, 255, 255, 0.15)'
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            margin: 0; 
            background-color: #050505; 
            color: #f5f5f7; 
            overflow-x: hidden; 
        }
        
        #canvas-container {
            position: fixed; inset: 0; z-index: 0;
            pointer-events: none;
        }

        /* Paneles de Texto - Inicialmente ocultos para ser animados por JS */
        .content-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-left: 3px solid var(--accent-color, #2997ff);
            padding: 2.5rem;
            border-radius: 0 1rem 1rem 0;
            max-width: 550px;
            opacity: 0; /* Controlado por GSAP */
            transform: translateY(30px); /* Controlado por GSAP */
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        
        .right-aligned {
            margin-left: auto;
            border-radius: 1rem 0 0 1rem;
            border-left: 1px solid var(--glass-border);
            border-right: 3px solid var(--accent-color, #2997ff);
            text-align: right;
        }

        /* Tipografía */
        h1, h2, h3 { font-family: 'Space Grotesk', sans-serif; letter-spacing: -0.02em; line-height: 1.1; }
        p { font-family: 'Inter', sans-serif; line-height: 1.7; color: #d1d1d6; font-size: 1rem; }
        strong { color: #fff; font-weight: 600; }
        
        /* Grid de Datos */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .kpi-item span:first-child { display: block; font-size: 0.75rem; text-transform: uppercase; color: #86868b; letter-spacing: 1px; margin-bottom: 4px; }
        .kpi-item span:last-child { display: block; font-size: 1.5rem; font-weight: 700; color: #fff; font-family: 'Space Grotesk', sans-serif; }

        /* Layout de Scroll */
        .scroll-section {
            min-height: 100vh;
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            padding: 0 5%;
            pointer-events: none; /* Dejar pasar eventos al canvas si no hay texto */
        }
        .scroll-section > * { pointer-events: auto; } /* Reactivar eventos en el panel */

        /* Navegación */
        .nav-dots {
            position: fixed; left: 20px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 12px; z-index: 50;
        }
        .dot {
            width: 8px; height: 8px; background: rgba(255,255,255,0.2); border-radius: 50%;
            transition: all 0.3s ease; cursor: pointer; border: 1px solid transparent;
        }
        .dot.active { background: #2997ff; transform: scale(1.3); box-shadow: 0 0 15px rgba(41, 151, 255, 0.5); border-color: #fff; }

        /* Líneas Decorativas */
        .hud-line {
            height: 2px; width: 60px; margin: 20px 0;
            background: linear-gradient(90deg, currentColor, transparent);
        }
        .right-aligned .hud-line { 
            background: linear-gradient(-90deg, currentColor, transparent); 
            margin-left: auto;
        }

        #loader { transition: opacity 0.8s ease; }
    </style>
</head>
<body>

    <!-- Pantalla de Carga -->
    <div id="loader" class="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center">
        <div class="font-display font-bold text-5xl tracking-tighter text-white mb-4">SMART<span class="text-brand-blue">TUNA</span></div>
        <div class="flex gap-2 items-center">
            <div class="w-2 h-2 bg-brand-blue rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-brand-blue rounded-full animate-bounce delay-100"></div>
            <div class="w-2 h-2 bg-brand-blue rounded-full animate-bounce delay-200"></div>
        </div>
        <div class="mt-4 text-xs font-mono text-gray-500 tracking-widest uppercase">Cargando Entorno 3D...</div>
    </div>

    <!-- Canvas 3D -->
    <div id="canvas-container"></div>

    <!-- Encabezado Fijo -->
    <div class="fixed top-0 w-full p-6 z-40 flex justify-between items-start pointer-events-none mix-blend-plus-lighter">
        <div>
            <div class="text-[10px] font-mono text-brand-blue mb-1 border border-brand-blue/30 inline-block px-2 py-0.5 rounded backdrop-blur-md">INFORME TÉCNICO 2025</div>
            <div class="text-xl font-bold text-white tracking-tight">Logística Integral de Enlatados</div>
        </div>
        <div class="hidden md:block text-right">
             <div class="text-[10px] font-mono text-gray-500 mb-1">ESTADO OPERATIVO</div>
             <div class="flex items-center justify-end gap-2">
                 <span id="status-indicator" class="w-2 h-2 bg-brand-blue rounded-full animate-pulse shadow-[0_0_10px_#2997ff]"></span>
                 <span id="status-text" class="text-xs font-bold text-white tracking-wider">ONLINE</span>
             </div>
        </div>
    </div>

    <!-- Navegación Lateral -->
    <div class="nav-dots">
        <div class="dot active" onclick="scrollToSec(0)"></div>
        <div class="dot" onclick="scrollToSec(1)"></div>
        <div class="dot" onclick="scrollToSec(2)"></div>
        <div class="dot" onclick="scrollToSec(3)"></div>
        <div class="dot" onclick="scrollToSec(4)"></div>
        <div class="dot" onclick="scrollToSec(5)"></div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <main>
        
        <!-- 0. INTRODUCCIÓN -->
        <section class="scroll-section" id="sec-0">
            <div class="content-panel" style="--accent-color: #2997ff;">
                <span class="text-xs font-mono text-brand-blue tracking-widest uppercase mb-2 block">Introducción</span>
                <h1 class="text-5xl md:text-7xl font-bold text-white mb-4">Ingeniería<br>Transoceánica.</h1>
                <div class="hud-line text-brand-blue"></div>
                <p class="text-lg">
                    El atún enlatado aparenta simplicidad, pero es el resultado de una orquestación logística compleja que desafía la biología, la termodinámica y las distancias globales.
                </p>
                <div class="mt-8 flex items-center gap-6 border-t border-white/10 pt-6">
                     <div class="text-xs text-gray-400">AUTORES<br><strong class="text-white text-sm">Ingeniería Industrial</strong></div>
                     <div class="h-8 w-[1px] bg-white/20"></div>
                     <div class="text-xs text-gray-400">UNIVERSIDAD<br><strong class="text-white text-sm">Del Atlántico</strong></div>
                </div>
            </div>
        </section>

        <!-- 1. PRODUCTO (Animación: Pelado de Etiqueta) -->
        <section class="scroll-section justify-end" id="sec-1">
            <div class="content-panel right-aligned" style="--accent-color: #32d74b;">
                <span class="text-xs font-mono text-green-400 tracking-widest uppercase mb-2 block">Caracterización del Producto</span>
                <h2 class="text-4xl font-bold text-white mb-4">Transparencia Total</h2>
                <div class="hud-line text-green-400"></div>
                <p class="mb-4">
                    La logística comienza con la biología. El <strong>Skipjack</strong> permite captura masiva y procesos rápidos, mientras que el <strong>Yellowfin</strong> exige un manejo premium para evitar daños mecánicos en la carne.
                </p>
                <p>
                    El envase de hojalata actúa como una barrera sanitaria perfecta, garantizando inocuidad sin necesidad de cadena de frío en el producto terminado.
                </p>
                <div class="kpi-grid">
                    <div class="kpi-item">
                        <span>Proteína Neta</span>
                        <span>20-30%</span>
                    </div>
                    <div class="kpi-item">
                        <span>Vida Útil</span>
                        <span>5 Años</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. RIESGO HISTAMINA (Animación: Luz Roja) -->
        <section class="scroll-section" id="sec-2">
            <div class="content-panel" style="--accent-color: #ff453a;">
                <span class="text-xs font-mono text-red-500 tracking-widest uppercase mb-2 block">Punto Crítico de Control</span>
                <h2 class="text-4xl font-bold text-white mb-4">La Barrera Térmica</h2>
                <div class="hud-line text-red-500"></div>
                <p class="mb-4">
                    El mayor riesgo logístico es la formación de <strong>histamina</strong>. Esta toxina es termoestable: ni siquiera el proceso de autoclave puede eliminarla una vez formada.
                </p>
                <div class="bg-red-900/20 border border-red-500/50 p-4 rounded-lg mb-4 flex items-start gap-3">
                    <div class="text-2xl">⚠️</div>
                    <p class="text-red-200 text-sm leading-relaxed m-0">
                        <strong>ALERTA CRÍTICA:</strong> Si la materia prima supera los <span class="text-white font-bold">4°C</span> post-captura por tiempo prolongado, el lote debe ser destruido.
                    </p>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-item">
                        <span>Límite Legal</span>
                        <span>50 PPM</span>
                    </div>
                    <div class="kpi-item">
                        <span>Temp. Máxima</span>
                        <span>4°C</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. ALMACENAMIENTO (Animación: Rack FIFO) -->
        <section class="scroll-section justify-end" id="sec-3">
            <div class="content-panel right-aligned" style="--accent-color: #ff9f0a;">
                <span class="text-xs font-mono text-orange-400 tracking-widest uppercase mb-2 block">Gestión de Inventario</span>
                <h2 class="text-4xl font-bold text-white mb-4">Sistema FIFO / FEFO</h2>
                <div class="hud-line text-orange-400"></div>
                <p class="mb-4">
                    La rotación es vital. Se prioriza el sistema <strong>FEFO</strong> (First Expired, First Out). La humedad en bodega debe mantenerse estrictamente bajo el 75% para evitar la corrosión externa de las latas ("lluvia de contenedor").
                </p>
                <p>
                    La estrategia de "Deslocalización de Lomos" permite procesar en origen, reduciendo el transporte de desperdicios en un 60%.
                </p>
            </div>
        </section>

        <!-- 4. TRANSPORTE (Animación: Contenedor/Azul) -->
        <section class="scroll-section" id="sec-4">
            <div class="content-panel" style="--accent-color: #2997ff;">
                <span class="text-xs font-mono text-brand-blue tracking-widest uppercase mb-2 block">Distribución Física</span>
                <h2 class="text-4xl font-bold text-white mb-4">Densidad de Carga</h2>
                <div class="hud-line text-brand-blue"></div>
                <p class="mb-4">
                    El atún se clasifica como "Dry Cargo" de alta densidad. El factor limitante en el transporte no es el volumen, sino el <strong>peso máximo por eje</strong>.
                </p>
                <p class="mb-4">
                    Por eficiencia, se utilizan exclusivamente contenedores <strong>TEU de 20 pies</strong>. Usar uno de 40 pies resultaría en espacio desperdiciado debido a las restricciones de peso en carretera.
                </p>
                <div class="kpi-grid">
                    <div class="kpi-item">
                        <span>Factor Estiba</span>
                        <span>1.68 m³/ton</span>
                    </div>
                    <div class="kpi-item">
                        <span>Equipo Óptimo</span>
                        <span>20' Dry Van</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. CIERRE -->
        <section class="scroll-section justify-center text-center" id="sec-5">
            <div class="content-panel" style="--accent-color: #ffd700; text-align: center; border-right: 3px solid #ffd700; border-left: 3px solid #ffd700; max-width: 700px;">
                <span class="text-xs font-mono text-yellow-400 tracking-widest uppercase mb-2 block">Mercado & Cliente</span>
                <h2 class="text-4xl font-bold text-white mb-4">El Pedido Perfecto</h2>
                <div class="hud-line text-yellow-400 mx-auto"></div>
                <p class="mb-8">
                    En un mercado de márgenes estrechos, la ventaja competitiva es la precisión logística: Entregas A tiempo (OTIF), Completas y con Documentación impecable.
                </p>
                <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="group relative px-8 py-3 bg-white/5 hover:bg-white/10 border border-white/20 rounded-full text-sm font-bold transition-all uppercase tracking-widest overflow-hidden">
                    <span class="relative z-10 group-hover:text-brand-blue transition-colors">Reiniciar Informe</span>
                    <div class="absolute inset-0 bg-white/0 group-hover:bg-white/5 transition-colors"></div>
                </button>
            </div>
        </section>

    </main>

    <!-- Librerías -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

    <script>
        // --- 1. CONFIGURACIÓN INICIAL ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.035);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 8);

        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- 2. MATERIALES & TEXTURAS ---
        function createMetalTex() {
            const c = document.createElement('canvas'); c.width=512; c.height=512;
            const x = c.getContext('2d');
            x.fillStyle='#999'; x.fillRect(0,0,512,512);
            // Ruido metálico
            for(let i=0; i<60000; i++) {
                x.fillStyle = Math.random()>0.5?'#aaa':'#888';
                x.fillRect(Math.random()*512, Math.random()*512, 2, 1);
            }
            const t = new THREE.CanvasTexture(c);
            return t;
        }

        function createHoloLabel() {
            const c = document.createElement('canvas'); c.width=1024; c.height=512;
            const x = c.getContext('2d');
            
            // Fondo degradado tecnológico
            const grd = x.createLinearGradient(0,0,0,512);
            grd.addColorStop(0, '#001a33'); grd.addColorStop(0.5, '#003366'); grd.addColorStop(1, '#001a33');
            x.fillStyle = grd; x.fillRect(0,0,1024,512);
            
            // Grid holográfico
            x.strokeStyle = 'rgba(41, 151, 255, 0.2)'; x.lineWidth=1;
            for(let i=0; i<1024; i+=40) { x.beginPath(); x.moveTo(i,0); x.lineTo(i,512); x.stroke(); }
            for(let i=0; i<512; i+=40) { x.beginPath(); x.moveTo(0,i); x.lineTo(1024,i); x.stroke(); }

            // Banda Dorada
            x.fillStyle = '#b8860b'; x.fillRect(0, 450, 1024, 20);
            
            // Texto Principal
            x.fillStyle='#fff'; x.font="900 80px Arial"; x.fillText("SMART TUNA", 50, 150);
            x.fillStyle='#4db8ff'; x.font="600 40px Arial"; x.fillText("LOMOS PREMIUM EN ACEITE", 50, 210);
            
            // Iconografía Logística
            x.strokeStyle='#fff'; x.lineWidth=3;
            x.strokeRect(800, 50, 150, 150);
            x.font="60px Arial"; x.fillText("UP", 845, 150);
            
            // Info nutricional simulada
            x.fillStyle='#ccc'; x.font="20px monospace"; 
            let txt = "PROTEINA: 24g | GRASA: 10g | SODIO: 300mg";
            x.fillText(txt, 50, 420);

            const t = new THREE.CanvasTexture(c); 
            t.anisotropy=16; 
            return t;
        }

        function createMeatTexture() {
            const c = document.createElement('canvas'); c.width=256; c.height=256;
            const x = c.getContext('2d');
            x.fillStyle='#e08e79'; x.fillRect(0,0,256,256); // Color base atún
            for(let i=0; i<5000; i++) {
                x.fillStyle = Math.random()>0.5?'#d07e69':'#f09e89';
                x.beginPath(); x.arc(Math.random()*256, Math.random()*256, Math.random()*2+1, 0, Math.PI*2); x.fill();
            }
            return new THREE.CanvasTexture(c);
        }

        // --- 3. OBJETOS 3D ---
        const mainGroup = new THREE.Group();
        scene.add(mainGroup);

        const metalMat = new THREE.MeshStandardMaterial({ 
            color: 0xffffff, roughness: 0.3, metalness: 0.8, bumpMap: createMetalTex(), bumpScale: 0.005 
        });
        const meatMat = new THREE.MeshStandardMaterial({
            map: createMeatTexture(), roughness: 0.8, color: 0xffcccc
        });

        // GEOMETRÍA DE LA LATA
        const canGroup = new THREE.Group();
        
        // Cuerpo interno (metal base)
        const canBody = new THREE.Mesh(new THREE.CylinderGeometry(0.99, 0.99, 1.0, 64), metalMat);
        canBody.castShadow = true;
        
        // Bordes
        const rimGeo = new THREE.TorusGeometry(1, 0.03, 16, 64);
        const rimTop = new THREE.Mesh(rimGeo, metalMat); rimTop.position.y = 0.5; rimTop.rotation.x = Math.PI/2;
        const rimBot = new THREE.Mesh(rimGeo, metalMat); rimBot.position.y = -0.5; rimBot.rotation.x = Math.PI/2;
        
        // Tapa
        const lid = new THREE.Mesh(new THREE.CylinderGeometry(0.98, 0.98, 0.02, 64), metalMat);
        lid.position.y = 0.48;
        
        // Abre fácil
        const tabGroup = new THREE.Group();
        const tabRing = new THREE.Mesh(new THREE.TorusGeometry(0.1, 0.015, 16, 32), metalMat);
        tabRing.rotation.x = Math.PI/2; tabRing.position.x = 0.35;
        const tabBase = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.01, 0.12), metalMat);
        tabBase.position.x = 0.15;
        tabGroup.add(tabRing, tabBase);
        tabGroup.position.set(0, 0.51, 0); 
        tabGroup.rotation.y = 0.5;

        // Carne (Interior)
        const meat = new THREE.Mesh(new THREE.CylinderGeometry(0.97, 0.97, 0.9, 32), meatMat);
        meat.visible = true; // Siempre visible, la etiqueta lo cubre

        // ETIQUETA PELABLE (Lógica corregida de main.html)
        // Usamos PlaneGeometry curvado manualmente para tener control total de vértices
        // CylinderGeometry es difícil de desenrollar. Usaremos un plano con muchos segmentos y lo enrollamos.
        const segW = 80; const segH = 10;
        const labelGeo = new THREE.PlaneGeometry(Math.PI * 2.05, 0.9, segW, segH);
        const labelMat = new THREE.MeshStandardMaterial({ 
            map: createHoloLabel(), 
            transparent: true, 
            side: THREE.DoubleSide, // Importante para ver el reverso al pelar
            roughness: 0.4,
            metalness: 0.2
        });
        const labelMesh = new THREE.Mesh(labelGeo, labelMat);
        
        // Función para enrollar el plano en un cilindro y aplicar pelado
        // val: 0.0 (cerrado) a 1.0 (pelado)
        function deformLabel(val) {
            const pos = labelGeo.attributes.position;
            const radius = 1.01; // Un poco más grande que la lata
            
            // Definimos el punto de corte para el efecto de pelado
            // A medida que val aumenta, más vértices se ven afectados
            // Usamos un ángulo de referencia.
            
            for(let i=0; i < pos.count; i++) {
                // Recuperamos coordenadas UV originales (suponiendo plano estándar centrado en 0)
                // PlaneGeometry crea width a lo largo de X.
                // X original va de -PI a +PI aprox.
                
                // Necesitamos el índice de columna para saber el ángulo original
                // width segments = 80. stride = 81 vertices per row.
                const col = i % (segW + 1);
                const row = Math.floor(i / (segW + 1));
                
                // Normalizamos col de 0 a 1
                const u = col / segW;
                
                // Ángulo alrededor del cilindro (cubriendo 360 grados + un poco de solape)
                const angle = u * Math.PI * 2; 
                
                // Coordenadas base cilíndricas
                let x = Math.sin(angle) * radius;
                let z = Math.cos(angle) * radius;
                let y = pos.getY(i); // Altura original se mantiene base
                
                // LÓGICA DE PELADO
                // El pelado empieza en un ángulo específico (digamos cerca de 0 o 2PI)
                // y progresa hacia atrás.
                
                // Umbral de pelado basado en 'val'
                // Si val = 0, peelAngle = 0. Si val = 1, peelAngle = PI (medio cilindro pelado)
                const peelExtent = Math.PI * 1.2; 
                const currentPeelAngle = val * peelExtent;
                
                // Definimos la "costura" donde empieza a abrirse. Digamos angle = 0.
                // Si el ángulo del vértice es menor que el ángulo de pelado actual, lo deformamos.
                
                if (angle < currentPeelAngle) {
                    // Este vértice está en la zona pelada.
                    // Lo proyectamos hacia afuera tangencialmente.
                    
                    const distFromPeelPoint = currentPeelAngle - angle;
                    
                    // Curvatura hacia afuera
                    const peelOut = distFromPeelPoint * 1.5; // Qué tanto se aleja
                    const peelCurl = distFromPeelPoint * 1.0; // Qué tanto se curva
                    
                    // Nueva posición: Desplazamos desde el punto de "bisagra" (currentPeelAngle)
                    // Bisagra x,z
                    const hingeX = Math.sin(currentPeelAngle) * radius;
                    const hingeZ = Math.cos(currentPeelAngle) * radius;
                    
                    // Dirección tangente hacia afuera
                    const tanX = Math.cos(currentPeelAngle);
                    const tanZ = -Math.sin(currentPeelAngle);
                    
                    // Aplicamos desplazamiento
                    x = hingeX + (tanX * peelOut) + (Math.sin(peelCurl) * 0.5);
                    z = hingeZ + (tanZ * peelOut) + (Math.cos(peelCurl) * 0.5);
                    
                    // Ligera torsión en Y para realismo
                    y += Math.sin(peelCurl) * 0.2 * val; 
                }
                
                // Escribir nuevos valores
                pos.setXYZ(i, x, y, z);
            }
            pos.needsUpdate = true;
            labelGeo.computeVertexNormals();
        }

        // Inicializar etiqueta cerrada
        deformLabel(0);

        canGroup.add(canBody, rimTop, rimBot, lid, tabGroup, meat, labelMesh);
        mainGroup.add(canGroup);

        // 2. EL RACK (Estantería FIFO)
        const rackGroup = new THREE.Group();
        const rackMat = new THREE.MeshStandardMaterial({ color: 0xe67e22, roughness: 0.7 }); // Naranja industrial
        
        // Postes
        const postGeo = new THREE.BoxGeometry(0.15, 6, 0.15);
        const p1 = new THREE.Mesh(postGeo, rackMat); p1.position.set(-2, 0, -1);
        const p2 = new THREE.Mesh(postGeo, rackMat); p2.position.set(2, 0, -1);
        
        // Vigas
        const beamGeo = new THREE.BoxGeometry(4.2, 0.1, 0.1);
        const b1 = new THREE.Mesh(beamGeo, rackMat); b1.position.set(0, -1, -1);
        const b2 = new THREE.Mesh(beamGeo, rackMat); b2.position.set(0, 1, -1);
        
        // Cajas
        const boxGeo = new THREE.BoxGeometry(0.8, 0.6, 0.8);
        const boxMat = new THREE.MeshStandardMaterial({ color: 0x8d6e63 });
        const box1 = new THREE.Mesh(boxGeo, boxMat); box1.position.set(-1.2, -0.65, -1);
        const box2 = new THREE.Mesh(boxGeo, boxMat); box2.position.set(0, -0.65, -1);
        const box3 = new THREE.Mesh(boxGeo, boxMat); box3.position.set(1.2, -0.65, -1);
        
        rackGroup.add(p1, p2, b1, b2, box1, box2, box3);
        rackGroup.position.set(0, -10, -3); // Escondido inicialmente
        mainGroup.add(rackGroup);


        // --- 4. ILUMINACIÓN ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
        scene.add(ambientLight);

        const spotLight = new THREE.SpotLight(0xffffff, 5);
        spotLight.position.set(5, 5, 5);
        spotLight.castShadow = true;
        scene.add(spotLight);

        const coloredLight = new THREE.PointLight(0x2997ff, 0, 10); // Empieza apagada
        coloredLight.position.set(-3, 2, 2);
        scene.add(coloredLight);


        // --- 5. ANIMACIONES (GSAP + ScrollTrigger) ---
        gsap.registerPlugin(ScrollTrigger);

        // A. Animación de Paneles de Texto (Aparición suave)
        gsap.utils.toArray('.content-panel').forEach(panel => {
            gsap.to(panel, {
                opacity: 1,
                y: 0,
                duration: 1,
                scrollTrigger: {
                    trigger: panel.parentElement, // La sección contenedora
                    start: "top 60%", // Empieza cuando la sección está al 60% de la pantalla
                    end: "bottom 40%",
                    toggleActions: "play reverse play reverse"
                }
            });
        });

        // B. Animación de Navegación (Dots)
        document.querySelectorAll('.scroll-section').forEach((sec, i) => {
            ScrollTrigger.create({
                trigger: sec,
                start: "top center",
                end: "bottom center",
                onEnter: () => updateDots(i),
                onEnterBack: () => updateDots(i)
            });
        });

        function updateDots(idx) {
            document.querySelectorAll('.dot').forEach((d, i) => {
                if (i === idx) d.classList.add('active');
                else d.classList.remove('active');
            });
        }

        // C. ANIMACIÓN 3D MAESTRA
        // TL0: Intro -> Producto
        gsap.timeline({
            scrollTrigger: { trigger: "#sec-0", start: "top top", end: "bottom top", scrub: 1 }
        })
        .to(camera.position, { z: 5, x: 0 })
        .to(canGroup.position, { x: -1.5 })
        .to(canGroup.rotation, { z: 0.2, y: -0.5 });

        // TL1: Pelado de Etiqueta (Sección 1)
        const peelObj = { val: 0 };
        gsap.timeline({
            scrollTrigger: { trigger: "#sec-1", start: "top top", end: "bottom top", scrub: 1 }
        })
        .to(peelObj, { 
            val: 1, 
            onUpdate: () => deformLabel(peelObj.val) // Aquí llamamos la función corregida
        })
        .to(canGroup.rotation, { y: -2 }, "<"); // Rotar para ver mejor el pelado

        // TL2: Histamina / Alerta Roja (Sección 2)
        gsap.timeline({
            scrollTrigger: { trigger: "#sec-2", start: "top top", end: "bottom top", scrub: 1,
                onEnter: () => {
                    document.getElementById('status-text').innerText = "ALERTA TÉRMICA";
                    document.getElementById('status-text').style.color = "#ff453a";
                    document.getElementById('status-indicator').classList.remove('bg-brand-blue');
                    document.getElementById('status-indicator').classList.add('bg-brand-red');
                },
                onLeaveBack: () => {
                    document.getElementById('status-text').innerText = "ONLINE";
                    document.getElementById('status-text').style.color = "#fff";
                    document.getElementById('status-indicator').classList.add('bg-brand-blue');
                    document.getElementById('status-indicator').classList.remove('bg-brand-red');
                }
            }
        })
        .to(peelObj, { val: 0, onUpdate: () => deformLabel(peelObj.val) }) // Cerrar etiqueta
        .to(canGroup.position, { x: 0 })
        .to(coloredLight, { intensity: 8 }) // Encender luz
        .to(coloredLight.color, { r: 1, g: 0.2, b: 0.2 }); // Rojo

        // TL3: Rack FIFO (Sección 3)
        gsap.timeline({
            scrollTrigger: { trigger: "#sec-3", start: "top top", end: "bottom top", scrub: 1 }
        })
        .to(canGroup.position, { x: 1.5, y: 0.5, z: 1 })
        .to(canGroup.scale, { x: 0.7, y: 0.7, z: 0.7 })
        .to(rackGroup.position, { y: 0 }) // Rack sube desde abajo
        .to(coloredLight.color, { r: 1, g: 0.6, b: 0.0 }); // Naranja

        // TL4: Contenedor (Sección 4)
        gsap.timeline({
            scrollTrigger: { trigger: "#sec-4", start: "top top", end: "bottom top", scrub: 1 }
        })
        .to(rackGroup.position, { y: 8 }) // Rack se va arriba
        .to(canGroup.scale, { x: 1, y: 1, z: 1 })
        .to(canGroup.position, { x: -1.5, y: 0, z: 0 })
        .to(coloredLight.color, { r: 0.2, g: 0.5, b: 1 }); // Azul

        // TL5: Final (Sección 5)
        gsap.timeline({
            scrollTrigger: { trigger: "#sec-5", start: "top top", end: "bottom top", scrub: 1 }
        })
        .to(canGroup.position, { x: 0, z: 2 })
        .to(canGroup.rotation, { x: Math.PI/2, y: 0 }) // Vista cenital de la tapa
        .to(coloredLight.color, { r: 1, g: 0.8, b: 0.2 }); // Dorado

        // Rotación pasiva
        function animate() {
            requestAnimationFrame(animate);
            if(!gsap.isTweening(canGroup.rotation)) {
                canGroup.rotation.y += 0.002;
            }
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Inicialización
        window.onload = () => {
            setTimeout(() => {
                const loader = document.getElementById('loader');
                loader.style.opacity = 0;
                setTimeout(() => {
                    loader.style.display = 'none';
                    animate();
                    // Refrescar ScrollTrigger para asegurar posiciones
                    ScrollTrigger.refresh();
                }, 800);
            }, 1500);
        };

    </script>
</body>
</html>
